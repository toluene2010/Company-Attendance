import streamlit as st
import pandas as pd
import gspread
from google.oauth2.service_account import Credentials
import datetime
from io import StringIO, BytesIO
import time
import base64
import os
import json
import calendar

# ==================== CONFIGURATION ====================
SHEET_NAME = "Company_Attendance"
SCOPES = [
    "https://www.googleapis.com/auth/spreadsheets",
    "https://www.googleapis.com/auth/drive"
]

# ==================== OFFLINE STORAGE ====================
OFFLINE_DATA_FILE = "offline_data.json"

def save_offline_data(data):
    """Save data to local file for offline use"""
    try:
        with open(OFFLINE_DATA_FILE, 'w') as f:
            json.dump(data, f)
        return True
    except Exception as e:
        st.error(f"Error saving offline data: {e}")
        return False

def load_offline_data():
    """Load data from local file for offline use"""
    try:
        if os.path.exists(OFFLINE_DATA_FILE):
            with open(OFFLINE_DATA_FILE, 'r') as f:
                return json.load(f)
    except Exception as e:
        st.error(f"Error loading offline data: {e}")
    return {}

def sync_offline_data():
    """Sync offline data with Google Sheets when online"""
    offline_data = load_offline_data()
    if not offline_data:
        return False
    
    synced = False
    for sheet_name, data in offline_data.items():
        if data and isinstance(data, list):
            df = pd.DataFrame(data)
            if write_sheet(sheet_name, df):
                synced = True
    
    if synced:
        # Clear offline data after successful sync
        try:
            os.remove(OFFLINE_DATA_FILE)
            st.success("Offline data synced successfully!")
        except:
            pass
        return True
    return False

# ==================== GOOGLE SHEETS CONNECTION ====================
@st.cache_resource
def connect_to_gsheets():
    try:
        creds = Credentials.from_service_account_file("service-account.json", scopes=SCOPES)
        client = gspread.authorize(creds)
        return client.open(SHEET_NAME)
    except Exception as e:
        st.error(f"Error connecting to Google Sheets: {e}")
        return None

@st.cache_data(ttl=300)
def read_sheet(sheet_name):
    # Try to read from Google Sheets first
    try:
        ss = connect_to_gsheets()
        if ss:
            worksheet = ss.worksheet(sheet_name)
            data = worksheet.get_all_records()
            return pd.DataFrame(data)
    except Exception as e:
        st.warning(f"Online connection failed: {e}. Using offline data if available.")
    
    # If online fails, try to load from offline storage
    offline_data = load_offline_data()
    if sheet_name in offline_data and offline_data[sheet_name]:
        return pd.DataFrame(offline_data[sheet_name])
    
    # If no offline data, return empty DataFrame
    return pd.DataFrame()

def write_sheet(sheet_name, df: pd.DataFrame):
    # Try to write to Google Sheets first
    try:
        ss = connect_to_gsheets()
        if ss:
            try:
                worksheet = ss.worksheet(sheet_name)
            except gspread.exceptions.WorksheetNotFound:
                worksheet = ss.add_worksheet(title=sheet_name, rows="1000", cols="20")
            
            # Convert all to string to avoid gspread type issues
            df_to_write = df.copy()
            for col in df_to_write.columns:
                df_to_write[col] = df_to_write[col].astype(str)
            
            worksheet.clear()
            worksheet.update([df_to_write.columns.values.tolist()] + df_to_write.values.tolist())
            
            # Clear cache so subsequent reads are fresh
            read_sheet.clear()
            return True
    except Exception as e:
        st.warning(f"Online connection failed: {e}. Saving data offline.")
    
    # If online fails, save to offline storage
    offline_data = load_offline_data()
    offline_data[sheet_name] = df.to_dict('records')
    save_offline_data(offline_data)
    return False

# ==================== MOBILE RESPONSIVENESS ====================
def mobile_responsive_css():
    return """
    <style>
    /* Mobile responsiveness */
    @media (max-width: 768px) {
        .main .block-container {
            padding-left: 1rem;
            padding-right: 1rem;
            max-width: 100%;
        }
        
        /* Adjust columns for mobile */
        div[data-testid="stHorizontalBlock"] > div {
            width: 100% !important;
            margin-bottom: 1rem;
        }
        
        /* Make tables scrollable horizontally */
        .stDataFrame {
            overflow-x: auto;
            display: block;
            white-space: nowrap;
        }
        
        /* Adjust form elements */
        .stTextInput, .stSelectbox, .stDateInput, .stTimeInput, .stNumberInput {
            margin-bottom: 1rem;
        }
        
        /* Adjust buttons */
        .stButton > button {
            width: 100%;
            margin-bottom: 0.5rem;
        }
        
        /* Adjust radio buttons */
        .stRadio > div {
            flex-direction: column;
        }
        
        .stRadio > div > label {
            margin-bottom: 0.5rem;
        }
        
        /* Adjust expanders */
        .streamlit-expanderHeader {
            font-size: 1rem;
            padding: 0.5rem 0;
        }
        
        /* Adjust metrics */
        div[data-testid="stMetric"] {
            margin-bottom: 1rem;
        }
        
        /* Adjust tabs */
        .stTabs > div > div > div > button {
            font-size: 0.8rem;
            padding: 0.5rem;
        }
    }
    
    /* Make sidebar more mobile-friendly */
    @media (max-width: 768px) {
        .css-1d391kg {
            padding-top: 1rem;
        }
        
        .css-1lcbmhc {
            padding: 1rem;
        }
    }
    
    /* Custom styles for attendance grid */
    .attendance-grid {
        font-size: 0.9rem;
    }
    
    .attendance-grid th {
        text-align: center;
        background-color: #f0f2f6;
        position: sticky;
        top: 0;
    }
    
    .attendance-grid td {
        text-align: center;
    }
    
    .present {
        color: green;
        font-weight: bold;
    }
    
    .absent {
        color: red;
        font-weight: bold;
    }
    
    .other-status {
        color: orange;
    }
    </style>
    """

# ==================== INITIALIZATION ====================
def initialize_system():
    # Shifts
    shifts = read_sheet("Shifts")
    if shifts.empty:
        shifts_df = pd.DataFrame({'ID':[1,2,3],'Name':['Morning','Afternoon','General']})
        write_sheet("Shifts", shifts_df)
    # Lines
    lines = read_sheet("Lines")
    if lines.empty:
        lines_df = pd.DataFrame({'ID':[1,2],'Name':['Line 1','Line 2'],'Description':['First','Second']})
        write_sheet("Lines", lines_df)
    # Users with default Admin if missing
    users = read_sheet("Users")
    if users.empty:
        users_df = pd.DataFrame([{
            'ID': 1,
            'Name': 'Admin User',
            'Username': 'admin',
            'Password': 'admin123',
            'Role': 'Admin',
            'Active': True,
            'Assigned_Line': '',
            'Assigned_Shift': ''
        }])
        write_sheet("Users", users_df)
    # Workers
    workers = read_sheet("Workers")
    if workers.empty:
        workers_df = pd.DataFrame(columns=['ID','Name','Line','Shift','Active'])
        write_sheet("Workers", workers_df)
    # Attendance
    attendance = read_sheet("Attendance")
    if attendance.empty:
        attendance_df = pd.DataFrame(columns=['ID','Worker_ID','Worker_Name','Date','Line','Shift','Status','Timestamp'])
        write_sheet("Attendance", attendance_df)

# ==================== SESSION ====================
if 'logged_in' not in st.session_state:
    st.session_state.logged_in = False
    st.session_state.username = None
    st.session_state.role = None
    st.session_state.user_id = None

# ==================== UTILITIES ====================
def normalize_active_column(df, col='Active'):
    if col not in df.columns:
        df[col] = True
    df[col] = df[col].astype(str).str.strip().str.upper()
    return df

def dataframe_to_excel_bytes(df: pd.DataFrame):
    bio = BytesIO()
    with pd.ExcelWriter(bio, engine="openpyxl") as writer:
        df.to_excel(writer, index=False)
    bio.seek(0)
    return bio

def generate_attendance_grid(year, month):
    """Generate attendance grid for the selected month and year"""
    # Get all workers
    workers_df = read_sheet("Workers")
    
    # Ensure required columns exist
    if 'Active' not in workers_df.columns:
        workers_df['Active'] = True
    if 'Line' not in workers_df.columns:
        workers_df['Line'] = ''
    if 'Shift' not in workers_df.columns:
        workers_df['Shift'] = ''
    
    # Filter active workers
    workers_df['Active'] = workers_df['Active'].astype(str)
    active_workers = workers_df[workers_df['Active'].str.lower().isin(['true','1','yes'])]
    
    if active_workers.empty:
        return pd.DataFrame()
    
    # Get attendance data for the selected month and year
    attendance_df = read_sheet("Attendance")
    
    if attendance_df.empty or 'Date' not in attendance_df.columns:
        return pd.DataFrame()
    
    # Convert Date to datetime
    attendance_df['Date'] = pd.to_datetime(attendance_df['Date'])
    
    # Filter for the selected month and year
    monthly_attendance = attendance_df[
        (attendance_df['Date'].dt.year == year) & 
        (attendance_df['Date'].dt.month == month)
    ]
    
    # Get number of days in the month
    days_in_month = calendar.monthrange(year, month)[1]
    
    # Create a base DataFrame with all workers
    grid_df = active_workers[['Name', 'Line', 'Shift']].copy()
    
    # Add columns for each day of the month
    for day in range(1, days_in_month + 1):
        grid_df[str(day)] = ''  # Initialize with empty string
    
    # Fill in attendance data
    for _, att in monthly_attendance.iterrows():
        worker_name = att['Worker_Name']
        day = att['Date'].day
        status = att['Status']
        
        # Find the worker in the grid
        worker_idx = grid_df[grid_df['Name'] == worker_name].index
        
        if not worker_idx.empty:
            if status == 'Present':
                grid_df.at[worker_idx[0], str(day)] = '‚úì'
            elif status == 'Absent':
                grid_df.at[worker_idx[0], str(day)] = '‚úó'
            else:
                grid_df.at[worker_idx[0], str(day)] = status[0]  # First letter of other statuses
    
    # Calculate present days and percentage
    present_counts = []
    percentages = []
    
    for _, worker in grid_df.iterrows():
        present_count = 0
        for day in range(1, days_in_month + 1):
            if worker[str(day)] == '‚úì':
                present_count += 1
        
        present_counts.append(present_count)
        # Calculate percentage (present days / total days in month * 100)
        percentage = (present_count / days_in_month) * 100
        percentages.append(round(percentage, 1))
    
    grid_df['Present Days'] = present_counts
    grid_df['Attendance %'] = percentages
    
    return grid_df

# ==================== AUTHENTICATION ====================
def login_page():
    st.title("üîê Company Attendance System")
    st.markdown("---")
    
    # Check for offline data and show sync option
    offline_data = load_offline_data()
    if offline_data:
        st.warning("You have unsynced data. Please connect to the internet and sync.")
        if st.button("Sync Offline Data"):
            if sync_offline_data():
                st.success("Data synced successfully!")
                st.rerun()
            else:
                st.error("Sync failed. Please try again later.")
    
    col1, col2, col3 = st.columns([1,2,1])
    with col2:
        st.subheader("Login")
        username = st.text_input("Username", key="login_username")
        password = st.text_input("Password", type="password", key="login_password")
        if st.button("Login", type="primary", use_container_width=True):
            users_df = read_sheet("Users")
            if users_df.empty:
                st.error("No users found. System needs initialization.")
                return
            # Normalize Active column
            users_df = normalize_active_column(users_df, 'Active')
            # Match
            user = users_df[
                (users_df['Username'] == username) &
                (users_df['Password'] == password) &
                (users_df['Active'].isin(["TRUE","YES","1"]))
            ]
            if not user.empty:
                st.session_state.logged_in = True
                st.session_state.username = username
                st.session_state.role = user.iloc[0]['Role']
                st.session_state.user_id = user.iloc[0]['ID']
                st.success(f"Welcome, {username}!")
                time.sleep(0.8)
                st.rerun()
            else:
                st.error("Invalid credentials or account inactive")

# ==================== ADMIN DASHBOARD ====================
def admin_dashboard():
    st.title("üîß Admin Dashboard")
    tab1, tab2, tab3, tab4, tab5 = st.tabs(["üë• Users","üì¶ Lines","üë∑ Workers","üìä Attendance","üóëÔ∏è Delete Data"])

    # ---- Users Tab ----
    with tab1:
        st.subheader("User Management")
        users_df = read_sheet("Users")
        col_a, col_b = st.columns([2,3])
        with col_a:
            st.markdown("#### ‚ûï Add New User")
            with st.form("add_user"):
                name = st.text_input("Full Name")
                username = st.text_input("Username")
                password = st.text_input("Password")
                role = st.selectbox("Role", ["Admin","Supervisor","HR"], key="admin_role")
                assigned_line = st.text_input("Assigned Line (optional)")
                assigned_shift = st.text_input("Assigned Shift (optional)")
                if st.form_submit_button("Add User"):
                    if name and username and password:
                        users_df = read_sheet("Users")
                        new_id = int(users_df['ID'].max())+1 if not users_df.empty and 'ID' in users_df.columns else 1
                        new_user = pd.DataFrame([{
                            'ID': new_id,
                            'Name': name,
                            'Username': username,
                            'Password': password,
                            'Role': role,
                            'Active': True,
                            'Assigned_Line': assigned_line,
                            'Assigned_Shift': assigned_shift
                        }])
                        users_df = pd.concat([users_df, new_user], ignore_index=True)
                        if write_sheet("Users", users_df):
                            st.success("User added")
                            st.rerun()
                    else:
                        st.error("Please fill all fields")
        with col_b:
            st.markdown("#### üìã All Users")
            users_df = read_sheet("Users")
            if not users_df.empty:
                users_df = normalize_active_column(users_df,'Active')
                for _, u in users_df.iterrows():
                    label = f"{'‚úÖ' if u['Active']=='TRUE' else '‚ùå'} {u['Name']} (@{u['Username']})"
                    with st.expander(label):
                        st.write(f"Role: {u['Role']}")
                        st.write(f"ID: {u['ID']}")
                        st.write(f"Assigned Line: {u.get('Assigned_Line','')}")
                        st.write(f"Assigned Shift: {u.get('Assigned_Shift','')}")
                        col1, col2 = st.columns(2)
                        with col1:
                            if u['Active']=='TRUE':
                                if st.button("Deactivate", key=f"deact_{u['ID']}"):
                                    users_df.loc[users_df['ID']==u['ID'],'Active'] = False
                                    write_sheet("Users", users_df)
                                    st.rerun()
                            else:
                                if st.button("Activate", key=f"act_{u['ID']}"):
                                    users_df.loc[users_df['ID']==u['ID'],'Active'] = True
                                    write_sheet("Users", users_df)
                                    st.rerun()
                        with col2:
                            if u['ID'] != st.session_state.user_id:
                                if st.button("üóëÔ∏è Delete", key=f"del_{u['ID']}"):
                                    users_df = users_df[users_df['ID'] != u['ID']]
                                    write_sheet("Users", users_df)
                                    st.rerun()
            else:
                st.info("No users found")

    # ---- Lines Tab ----
    with tab2:
        st.subheader("Packaging Lines")
        lines_df = read_sheet("Lines")
        col1, col2 = st.columns([2,3])
        with col1:
            st.markdown("#### ‚ûï Add Line")
            with st.form("add_line"):
                line_name = st.text_input("Line Name")
                desc = st.text_area("Description")
                if st.form_submit_button("Add Line"):
                    if line_name:
                        lines_df = read_sheet("Lines")
                        new_id = int(lines_df['ID'].max())+1 if not lines_df.empty and 'ID' in lines_df.columns else 1
                        new_line = pd.DataFrame([{'ID':new_id,'Name':line_name,'Description':desc}])
                        lines_df = pd.concat([lines_df, new_line], ignore_index=True)
                        if write_sheet("Lines", lines_df):
                            st.success("Line added")
                            st.rerun()
                    else:
                        st.error("Enter line name")
        with col2:
            st.markdown("#### üìã All Lines")
            if not lines_df.empty:
                st.dataframe(lines_df, use_container_width=True)
            else:
                st.info("No lines found")

    # ---- Workers Tab ----
    with tab3:
        st.subheader("Worker Management")
        lines_df = read_sheet("Lines")
        shifts_df = read_sheet("Shifts")
        workers_df = read_sheet("Workers")
        
        # Ensure required columns exist
        if 'Active' not in workers_df.columns:
            workers_df['Active'] = True
        if 'Line' not in workers_df.columns:
            workers_df['Line'] = ''
        if 'Shift' not in workers_df.columns:
            workers_df['Shift'] = ''

        col1, col2 = st.columns([2,3])

        # Upload Workers from Excel
        with col1:
            st.markdown("#### üì§ Upload Workers from Excel (.xlsx)")
            uploaded_file = st.file_uploader("Upload Excel File", type=["xlsx"], key="admin_upload_workers")
            if uploaded_file is not None:
                try:
                    uploaded_df = pd.read_excel(uploaded_file)
                    required_cols = {"Name","Line","Shift"}
                    if not required_cols.issubset(uploaded_df.columns):
                        st.error("Excel must contain columns: Name, Line, Shift")
                    else:
                        # load current workers
                        workers_df = read_sheet("Workers")
                        if workers_df.empty:
                            workers_df = pd.DataFrame(columns=['ID','Name','Line','Shift','Active'])
                        # Ensure required columns exist
                        if 'Active' not in workers_df.columns:
                            workers_df['Active'] = True
                        if 'Line' not in workers_df.columns:
                            workers_df['Line'] = ''
                        if 'Shift' not in workers_df.columns:
                            workers_df['Shift'] = ''
                        # Prevent duplicates (Name+Line+Shift)
                        def is_duplicate(row):
                            return ((workers_df['Name'] == row['Name']) & 
                                    (workers_df['Line'] == row['Line']) &
                                    (workers_df['Shift'] == row['Shift'])).any()
                        new_rows = []
                        next_id = int(workers_df['ID'].max())+1 if not workers_df.empty and 'ID' in workers_df.columns else 1
                        for idx, r in uploaded_df.iterrows():
                            if not is_duplicate(r):
                                new_rows.append({'ID': next_id, 'Name': r['Name'], 'Line': r['Line'], 'Shift': r['Shift'], 'Active': True})
                                next_id += 1
                        if not new_rows:
                            st.warning("All uploaded workers already exist. No new workers added.")
                        else:
                            add_df = pd.DataFrame(new_rows)
                            workers_df = pd.concat([workers_df, add_df], ignore_index=True)
                            if write_sheet("Workers", workers_df):
                                st.success(f"Added {len(add_df)} new workers")
                                st.rerun()
                except Exception as e:
                    st.error(f"Error reading Excel file: {e}")

            st.markdown("#### ‚ûï Add Single Worker (Admin)")
            with st.form("add_worker_admin"):
                w_name = st.text_input("Name")
                w_line = st.selectbox("Line", lines_df['Name'].tolist() if not lines_df.empty else [], key="admin_add_line")
                w_shift = st.selectbox("Shift", read_sheet("Shifts")['Name'].tolist() if not read_sheet("Shifts").empty else [], key="admin_add_shift")
                if st.form_submit_button("Add Worker"):
                    if w_name and w_line and w_shift:
                        workers_df = read_sheet("Workers")
                        # Ensure required columns exist
                        if 'Active' not in workers_df.columns:
                            workers_df['Active'] = True
                        if 'Line' not in workers_df.columns:
                            workers_df['Line'] = ''
                        if 'Shift' not in workers_df.columns:
                            workers_df['Shift'] = ''
                        new_id = int(workers_df['ID'].max())+1 if not workers_df.empty and 'ID' in workers_df.columns else 1
                        new_worker = pd.DataFrame([{'ID':new_id,'Name':w_name,'Line':w_line,'Shift':w_shift,'Active':True}])
                        workers_df = pd.concat([workers_df,new_worker], ignore_index=True)
                        if write_sheet("Workers", workers_df):
                            st.success("Worker added")
                            st.rerun()
                    else:
                        st.error("Fill all fields")

        # Worker list + export
        with col2:
            st.markdown("#### üìã All Workers")
            workers_df = read_sheet("Workers")
            # Ensure required columns exist
            if 'Active' not in workers_df.columns:
                workers_df['Active'] = True
            if 'Line' not in workers_df.columns:
                workers_df['Line'] = ''
            if 'Shift' not in workers_df.columns:
                workers_df['Shift'] = ''
            workers_df['Active'] = workers_df['Active'].astype(str)
            st.write(f"**Total: {len(workers_df)} workers**")
            # Export button (Excel in-memory)
            excel_bytes = dataframe_to_excel_bytes(workers_df)
            st.download_button("üì• Download Workers Excel", data=excel_bytes, file_name="workers.xlsx", mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
            st.markdown("---")
            for _, w in workers_df.iterrows():
                with st.expander(f"{'‚úÖ' if str(w['Active']).lower() in ['true','1','yes'] else '‚ùå'} {w['Name']} - {w['Line']} ({w['Shift']})"):
                    st.write(f"ID: {w['ID']}")
                    colA, colB = st.columns([3,1])
                    with colA:
                        if st.button("Deactivate" if str(w['Active']).lower() in ['true','1','yes'] else "Activate", key=f"toggle_worker_{w['ID']}"):
                            df = read_sheet("Workers")
                            # Ensure required columns exist
                            if 'Active' not in df.columns:
                                df['Active'] = True
                            if 'Line' not in df.columns:
                                df['Line'] = ''
                            if 'Shift' not in df.columns:
                                df['Shift'] = ''
                            df.loc[df['ID'] == w['ID'], 'Active'] = not (str(w['Active']).lower() in ['true','1','yes'])
                            write_sheet("Workers", df)
                            st.rerun()
                    with colB:
                        # Worker ID display
                        st.write(f"ID: {w['ID']}")
            else:
                st.info("No workers found")

    # ---- Attendance Tab (Admin view) ----
    with tab4:
        st.subheader("üìä Attendance Records")
        att = read_sheet("Attendance")
        if not att.empty:
            # Check if 'Date' column exists
            if 'Date' in att.columns:
                att['Date'] = pd.to_datetime(att['Date']).dt.date
                view_date = st.date_input("Select Date", datetime.date.today(), key="admin_view_date")
                filtered = att[att['Date'] == view_date]
                if not filtered.empty:
                    st.write(f"Attendance for {view_date.strftime('%B %d, %Y')}")
                    # show register table
                    st.dataframe(filtered[['Worker_Name','Line','Shift','Status','Timestamp']], use_container_width=True)
                    # stats
                    total = len(filtered)
                    present = len(filtered[filtered['Status']=='Present'])
                    absent = len(filtered[filtered['Status']=='Absent'])
                    late = len(filtered[filtered['Status']=='Late'])
                    leave = len(filtered[filtered['Status']=='Leave'])
                    col1,col2,col3,col4 = st.columns(4)
                    with col1: st.metric("Present", present, f"{present/total*100:.1f}%")
                    with col2: st.metric("Absent", absent, f"{absent/total*100:.1f}%")
                    with col3: st.metric("Late", late, f"{late/total*100:.1f}%")
                    with col4: st.metric("Leave", leave, f"{leave/total*100:.1f}%")
                    # Download CSV
                    csv = filtered.to_csv(index=False).encode('utf-8')
                    st.download_button("üì• Download Attendance CSV", csv, file_name=f"attendance_{view_date}.csv")
                else:
                    st.info("No attendance records for selected date.")
            else:
                st.error("Attendance data is missing the 'Date' column. Please check your data structure.")
        else:
            st.info("No attendance data yet.")

    # ---- Delete Data Tab ----
    with tab5:
        st.subheader("Danger Zone - Delete Data")
        if st.button("Clear All Attendance", key="clear_attendance"):
            write_sheet("Attendance", pd.DataFrame(columns=['ID','Worker_ID','Worker_Name','Date','Line','Shift','Status','Timestamp']))
            st.success("Attendance cleared")
        if st.button("Clear All Workers", key="clear_workers"):
            write_sheet("Workers", pd.DataFrame(columns=['ID','Name','Line','Shift','Active']))
            st.success("Workers cleared")

# ==================== SUPERVISOR DASHBOARD ====================
def supervisor_dashboard():
    st.title("üë∑ Supervisor Dashboard")
    tab1, tab2, tab3, tab4, tab5, tab6 = st.tabs(["‚úÖ Mark Attendance", "üìä Attendance Register", "üîÑ Transfer Workers", "üë• Manage Workers", "üìÖ View Attendance", "üìä Attendance Grid"])

    lines_df = read_sheet("Lines")
    shifts_df = read_sheet("Shifts")
    workers_df = read_sheet("Workers")
    
    # Ensure required columns exist in Workers DataFrame
    if 'Active' not in workers_df.columns:
        workers_df['Active'] = True
    if 'Line' not in workers_df.columns:
        workers_df['Line'] = ''
    if 'Shift' not in workers_df.columns:
        workers_df['Shift'] = ''

    # ---------- TAB 1: Mark Attendance ----------
    with tab1:
        st.subheader("‚úÖ Mark Attendance")
        
        # Date selector for marking attendance (past or future)
        mark_date = st.date_input("Select Date for Attendance", datetime.date.today(), key="mark_date")
        
        col1, col2 = st.columns(2)
        with col1:
            selected_line = st.selectbox("Select Line", ["All"] + (lines_df['Name'].tolist() if not lines_df.empty else []), key="mark_line")
        with col2:
            selected_shift = st.selectbox("Select Shift", ["All"] + (shifts_df['Name'].tolist() if not shifts_df.empty else []), key="mark_shift")

        # Filter workers based on selection
        wdf = read_sheet("Workers")
        # Ensure required columns exist
        if 'Active' not in wdf.columns:
            wdf['Active'] = True
        if 'Line' not in wdf.columns:
            wdf['Line'] = ''
        if 'Shift' not in wdf.columns:
            wdf['Shift'] = ''
        wdf['Active'] = wdf['Active'].astype(str)
        filtered = wdf.copy()
        
        # Apply filters only if columns exist
        if selected_line != "All" and 'Line' in filtered.columns:
            filtered = filtered[filtered['Line'] == selected_line]
        if selected_shift != "All" and 'Shift' in filtered.columns:
            filtered = filtered[filtered['Shift'] == selected_shift]
        filtered = filtered[filtered['Active'].str.lower().isin(['true','1','yes'])]

        if filtered.empty:
            st.info("No active workers for selected filters.")
        else:
            st.write(f"### üìã Mark Attendance for {mark_date.strftime('%B %d, %Y')} ({len(filtered)} workers)")
            
            # Check if attendance already exists for this date and workers
            att_df = read_sheet("Attendance")
            
            # Only process if 'Date' column exists
            if not att_df.empty and 'Date' in att_df.columns:
                att_df['Date'] = pd.to_datetime(att_df['Date']).dt.date
                
                # Get existing attendance for the selected date and workers
                existing_att = att_df[
                    (att_df['Date'] == mark_date) &
                    (att_df['Worker_ID'].isin(filtered['ID'].astype(str)))
                ]
            else:
                existing_att = pd.DataFrame()
            
            # For marking attendance, render radio widgets
            with st.form("mark_attendance_form"):
                statuses = {}
                for _, worker in filtered.iterrows():
                    worker_id_str = str(worker['ID'])
                    worker_name = worker['Name']
                    worker_line = worker.get('Line', '')
                    worker_shift = worker.get('Shift', '')
                    
                    # Check if attendance already exists for this worker
                    if not existing_att.empty and 'Worker_ID' in existing_att.columns:
                        worker_att = existing_att[existing_att['Worker_ID'] == worker_id_str]
                        if not worker_att.empty and 'Status' in worker_att.columns:
                            current_status = worker_att.iloc[0]['Status']
                            default_idx = ["Present", "Absent", "Late", "Leave"].index(current_status) if current_status in ["Present", "Absent", "Late", "Leave"] else 0
                        else:
                            default_idx = 0
                    else:
                        default_idx = 0
                    
                    st.write(f"**{worker_name}** - {worker_line} / {worker_shift}")
                    status = st.radio("Status", ["Present","Absent","Late","Leave"], index=default_idx, key=f"stat_{worker['ID']}", horizontal=True, label_visibility="collapsed")
                    statuses[int(worker['ID'])] = {'name': worker_name, 'status': status, 'line': worker_line, 'shift': worker_shift}
                
                if st.form_submit_button("Submit Attendance"):
                    # Initialize att_df if it's empty
                    if att_df.empty:
                        att_df = pd.DataFrame(columns=['ID','Worker_ID','Worker_Name','Date','Line','Shift','Status','Timestamp'])
                    
                    next_id = int(att_df['ID'].max())+1 if not att_df.empty and 'ID' in att_df.columns else 1
                    date_str = mark_date.strftime('%Y-%m-%d')
                    new_records = []
                    
                    for wid, info in statuses.items():
                        worker_id_str = str(wid)
                        # Check if this record already exists
                        if not existing_att.empty and 'Worker_ID' in existing_att.columns:
                            existing_record = existing_att[existing_att['Worker_ID'] == worker_id_str]
                            
                            if not existing_record.empty:
                                # Update existing record
                                record_id = existing_record.iloc[0]['ID']
                                att_df.loc[att_df['ID'] == record_id, 'Status'] = info['status']
                                att_df.loc[att_df['ID'] == record_id, 'Timestamp'] = datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            else:
                                # Add new record
                                new_records.append({
                                    'ID': next_id,
                                    'Worker_ID': wid,
                                    'Worker_Name': info['name'],
                                    'Date': date_str,
                                    'Line': info['line'],
                                    'Shift': info['shift'],
                                    'Status': info['status'],
                                    'Timestamp': datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                                })
                                next_id += 1
                        else:
                            # Add new record
                            new_records.append({
                                'ID': next_id,
                                'Worker_ID': wid,
                                'Worker_Name': info['name'],
                                'Date': date_str,
                                'Line': info['line'],
                                'Shift': info['shift'],
                                'Status': info['status'],
                                'Timestamp': datetime.datetime.now().strftime('%Y-%m-%d %H:%M:%S')
                            })
                            next_id += 1
                    
                    if new_records:
                        new_att = pd.DataFrame(new_records)
                        att_df = pd.concat([att_df, new_att], ignore_index=True)
                    
                    if write_sheet("Attendance", att_df):
                        st.success(f"Updated attendance for {len(filtered)} workers")
                        st.rerun()

    # ---------- TAB 2: Attendance Register ----------
    with tab2:
        st.subheader("üìä Attendance Register")
        
        # Date selector for viewing attendance register
        reg_date = st.date_input("Select Date for Register", datetime.date.today(), key="reg_date")
        
        col1, col2 = st.columns(2)
        with col1:
            reg_line = st.selectbox("Select Line", ["All"] + (lines_df['Name'].tolist() if not lines_df.empty else []), key="reg_line")
        with col2:
            reg_shift = st.selectbox("Select Shift", ["All"] + (shifts_df['Name'].tolist() if not shifts_df.empty else []), key="reg_shift")
        
        # Get attendance data
        att = read_sheet("Attendance")
        if not att.empty:
            # Check if 'Date' column exists
            if 'Date' in att.columns:
                att['Date'] = pd.to_datetime(att['Date']).dt.date
                filtered = att[att['Date'] == reg_date]
                
                if reg_line != "All" and 'Line' in filtered.columns:
                    filtered = filtered[filtered['Line'] == reg_line]
                if reg_shift != "All" and 'Shift' in filtered.columns:
                    filtered = filtered[filtered['Shift'] == reg_shift]
                
                if not filtered.empty:
                    st.write(f"### Attendance Register for {reg_date.strftime('%B %d, %Y')}")
                    st.dataframe(filtered[['Worker_Name','Line','Shift','Status','Timestamp']], use_container_width=True)
                    
                    # stats
                    total = len(filtered)
                    present = len(filtered[filtered['Status']=='Present'])
                    absent = len(filtered[filtered['Status']=='Absent'])
                    late = len(filtered[filtered['Status']=='Late'])
                    leave = len(filtered[filtered['Status']=='Leave'])
                    col1,col2,col3,col4 = st.columns(4)
                    with col1: st.metric("Present", present, f"{present/total*100:.1f}%")
                    with col2: st.metric("Absent", absent, f"{absent/total*100:.1f}%")
                    with col3: st.metric("Late", late, f"{late/total*100:.1f}%")
                    with col4: st.metric("Leave", leave, f"{leave/total*100:.1f}%")
                    
                    # Download CSV
                    csv = filtered.to_csv(index=False).encode('utf-8')
                    st.download_button("üì• Download Attendance CSV", csv, file_name=f"attendance_{reg_date}.csv")
                else:
                    st.info("No attendance records for selected filters.")
            else:
                st.error("Attendance data is missing the 'Date' column. Please check your data structure.")
        else:
            st.info("No attendance data")

    # ---------- TAB 3: Transfer Workers ----------
    with tab3:
        st.subheader("üîÑ Transfer Workers")
        wdf = read_sheet("Workers")
        # Ensure required columns exist
        if 'Active' not in wdf.columns:
            wdf['Active'] = True
        if 'Line' not in wdf.columns:
            wdf['Line'] = ''
        if 'Shift' not in wdf.columns:
            wdf['Shift'] = ''
        if not wdf.empty:
            active = wdf[wdf['Active'].astype(str).str.lower().isin(['true','1','yes'])]
            if not active.empty:
                sel = st.selectbox("Select Worker", active['Name'].tolist(), key="transfer_worker")
                row = active[active['Name']==sel].iloc[0]
                st.write(f"Current: {row.get('Line', '')} - {row.get('Shift', '')}")
                col1,col2 = st.columns(2)
                with col1:
                    new_line = st.selectbox("New Line", lines_df['Name'].tolist(), key="new_line")
                with col2:
                    new_shift = st.selectbox("New Shift", shifts_df['Name'].tolist(), key="new_shift")
                if st.button("Transfer Worker", key="transfer_btn"):
                    wdf.loc[wdf['ID']==row['ID'],'Line'] = new_line
                    wdf.loc[wdf['ID']==row['ID'],'Shift'] = new_shift
                    write_sheet("Workers", wdf)
                    st.success("Transferred")
            else:
                st.info("No active workers")
        else:
            st.info("No workers found")

    # ---------- TAB 4: Manage Workers ----------
    with tab4:
        st.subheader("üë• Manage Workers")
        wdf = read_sheet("Workers")
        # Ensure required columns exist
        if 'Active' not in wdf.columns:
            wdf['Active'] = True
        if 'Line' not in wdf.columns:
            wdf['Line'] = ''
        if 'Shift' not in wdf.columns:
            wdf['Shift'] = ''
        if not wdf.empty:
            for _, w in wdf.iterrows():
                with st.expander(f"{'‚úÖ' if str(w['Active']).lower() in ['true','1','yes'] else '‚ùå'} {w['Name']} - {w.get('Line', '')} ({w.get('Shift', '')})"):
                    st.write(f"ID: {w['ID']}")
                    st.write(f"Line: {w.get('Line', '')} | Shift: {w.get('Shift', '')}")
                    col1,col2 = st.columns([3,1])
                    with col1:
                        if str(w['Active']).lower() in ['true','1','yes']:
                            if st.button("Deactivate", key=f"sup_deact_{w['ID']}"):
                                df = read_sheet("Workers")
                                # Ensure required columns exist
                                if 'Active' not in df.columns:
                                    df['Active'] = True
                                if 'Line' not in df.columns:
                                    df['Line'] = ''
                                if 'Shift' not in df.columns:
                                    df['Shift'] = ''
                                df.loc[df['ID']==w['ID'],'Active'] = False
                                write_sheet("Workers", df)
                                st.rerun()
                        else:
                            if st.button("Activate", key=f"sup_act_{w['ID']}"):
                                df = read_sheet("Workers")
                                # Ensure required columns exist
                                if 'Active' not in df.columns:
                                    df['Active'] = True
                                if 'Line' not in df.columns:
                                    df['Line'] = ''
                                if 'Shift' not in df.columns:
                                    df['Shift'] = ''
                                df.loc[df['ID']==w['ID'],'Active'] = True
                                write_sheet("Workers", df)
                                st.rerun()
                    with col2:
                        if st.button("üóëÔ∏è Delete", key=f"sup_del_{w['ID']}"):
                            df = read_sheet("Workers")
                            df = df[df['ID'] != w['ID']]
                            write_sheet("Workers", df)
                            st.rerun()
        else:
            st.info("No workers found")

    # ---------- TAB 5: View Attendance ----------
    with tab5:
        st.subheader("üìÖ View Attendance")
        att = read_sheet("Attendance")
        if not att.empty:
            # Check if 'Date' column exists
            if 'Date' in att.columns:
                att['Date'] = pd.to_datetime(att['Date']).dt.date
                view_date = st.date_input("Date", datetime.date.today(), key="sup_view_date")
                view_line = st.selectbox("Line", ["All"] + (lines_df['Name'].tolist() if not lines_df.empty else []), key="sup_view_line")
                view_shift = st.selectbox("Shift", ["All"] + (shifts_df['Name'].tolist() if not shifts_df.empty else []), key="sup_view_shift")
                filtered = att[att['Date'] == view_date]
                if view_line != "All" and 'Line' in filtered.columns:
                    filtered = filtered[filtered['Line'] == view_line]
                if view_shift != "All" and 'Shift' in filtered.columns:
                    filtered = filtered[filtered['Shift'] == view_shift]
                if not filtered.empty:
                    st.write(f"### Attendance Register - {view_date.strftime('%B %d, %Y')}")
                    st.dataframe(filtered[['Worker_Name','Line','Shift','Status','Timestamp']], use_container_width=True)
                    # stats
                    total = len(filtered)
                    present = len(filtered[filtered['Status']=='Present'])
                    absent = len(filtered[filtered['Status']=='Absent'])
                    late = len(filtered[filtered['Status']=='Late'])
                    leave = len(filtered[filtered['Status']=='Leave'])
                    col1,col2,col3,col4 = st.columns(4)
                    with col1: st.metric("Present", present, f"{present/total*100:.1f}%")
                    with col2: st.metric("Absent", absent, f"{absent/total*100:.1f}%")
                    with col3: st.metric("Late", late, f"{late/total*100:.1f}%")
                    with col4: st.metric("Leave", leave, f"{leave/total*100:.1f}%")
                else:
                    st.info("No records found")
            else:
                st.error("Attendance data is missing the 'Date' column. Please check your data structure.")
        else:
            st.info("No attendance data")

    # ---------- TAB 6: Attendance Grid ----------
    with tab6:
        st.subheader("üìä Attendance Grid")
        
        col1, col2 = st.columns(2)
        with col1:
            year = st.selectbox("Year", list(range(2020, datetime.date.today().year + 2)), 
                                 index=list(range(2020, datetime.date.today().year + 2)).index(datetime.date.today().year),
                                 key="sup_grid_year")
        with col2:
            month = st.selectbox("Month", list(range(1, 13)), 
                                 index=datetime.date.today().month - 1,
                                 key="sup_grid_month")
        
        # Generate attendance grid
        grid_df = generate_attendance_grid(year, month)
        
        if not grid_df.empty:
            # Apply custom CSS for the grid
            st.markdown('<div class="attendance-grid">', unsafe_allow_html=True)
            
            # Display the grid
            st.dataframe(
                grid_df,
                use_container_width=True,
                column_config={
                    "Name": st.column_config.TextColumn("Name", width="medium"),
                    "Shift": st.column_config.TextColumn("Shift", width="small"),
                    "Line": st.column_config.TextColumn("Line", width="small"),
                    "Present Days": st.column_config.NumberColumn("Present Days", format="%d"),
                    "Attendance %": st.column_config.NumberColumn("Attendance %", format="%.1f%%")
                }
            )
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            # Export button
            excel_bytes = dataframe_to_excel_bytes(grid_df)
            st.download_button(
                "üì• Download Attendance Grid", 
                data=excel_bytes, 
                file_name=f"attendance_grid_{year}_{month}.xlsx", 
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        else:
            st.info("No attendance data available for the selected period.")

# ==================== HR DASHBOARD ====================
def hr_dashboard():
    st.title("üìä HR Dashboard")
    tab1, tab2, tab3, tab4 = st.tabs(["üìä Daily","üìÖ Monthly","üë• Directory", "üìä Attendance Grid"])
    lines_df = read_sheet("Lines")
    workers_df = read_sheet("Workers")
    attendance_df = read_sheet("Attendance")
    
    # Ensure required columns exist in Workers DataFrame
    if 'Active' not in workers_df.columns:
        workers_df['Active'] = True
    if 'Line' not in workers_df.columns:
        workers_df['Line'] = ''
    if 'Shift' not in workers_df.columns:
        workers_df['Shift'] = ''

    with tab1:
        st.subheader("üìä Daily Attendance")
        view_date = st.date_input("Date", datetime.date.today(), key="hr_daily_date")
        if not attendance_df.empty:
            # Check if 'Date' column exists
            if 'Date' in attendance_df.columns:
                attendance_df['Date'] = pd.to_datetime(attendance_df['Date']).dt.date
                filtered = attendance_df[attendance_df['Date'] == view_date]
                if not filtered.empty:
                    st.dataframe(filtered[['Worker_Name','Line','Shift','Status','Timestamp']], use_container_width=True)
                    total = len(filtered)
                    present = len(filtered[filtered['Status']=='Present'])
                    absent = len(filtered[filtered['Status']=='Absent'])
                    late = len(filtered[filtered['Status']=='Late'])
                    leave = len(filtered[filtered['Status']=='Leave'])
                    c1,c2,c3,c4 = st.columns(4)
                    with c1: st.metric("Present", present, f"{present/total*100:.1f}%")
                    with c2: st.metric("Absent", absent, f"{absent/total*100:.1f}%")
                    with c3: st.metric("Late", late, f"{late/total*100:.1f}%")
                    with c4: st.metric("Leave", leave, f"{leave/total*100:.1f}%")
                else:
                    st.info("No attendance records for date")
            else:
                st.error("Attendance data is missing the 'Date' column. Please check your data structure.")
        else:
            st.info("No attendance data")

    with tab2:
        st.subheader("üìÖ Monthly Analysis")
        year = st.selectbox("Year", list(range(2023, datetime.date.today().year+2)), 
                             index=list(range(2023, datetime.date.today().year+2)).index(datetime.date.today().year),
                             key="hr_monthly_year")
        month = st.selectbox("Month", list(range(1,13)), 
                             index=datetime.date.today().month-1,
                             key="hr_monthly_month")
        if not attendance_df.empty:
            # Check if 'Date' column exists
            if 'Date' in attendance_df.columns:
                attendance_df['Date'] = pd.to_datetime(attendance_df['Date'])
                monthly = attendance_df[(attendance_df['Date'].dt.year==year) & (attendance_df['Date'].dt.month==month)]
                if not monthly.empty:
                    pivot = monthly.pivot_table(index='Worker_Name', columns=monthly['Date'].dt.day, values='Status', aggfunc='first')
                    st.dataframe(pivot, use_container_width=True)
                else:
                    st.info("No data for this month")
            else:
                st.error("Attendance data is missing the 'Date' column. Please check your data structure.")
        else:
            st.info("No attendance data")

    with tab3:
        st.subheader("üë• Worker Directory")
        if not workers_df.empty:
            st.dataframe(workers_df, use_container_width=True)
            # export
            excel_bytes = dataframe_to_excel_bytes(workers_df)
            st.download_button("üì• Download Worker Directory", data=excel_bytes, file_name="worker_directory.xlsx", mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet")
        else:
            st.info("No workers")

    with tab4:
        st.subheader("üìä Attendance Grid")
        
        col1, col2 = st.columns(2)
        with col1:
            year = st.selectbox("Year", list(range(2020, datetime.date.today().year + 2)), 
                                 index=list(range(2020, datetime.date.today().year + 2)).index(datetime.date.today().year),
                                 key="hr_grid_year")
        with col2:
            month = st.selectbox("Month", list(range(1, 13)), 
                                 index=datetime.date.today().month - 1,
                                 key="hr_grid_month")
        
        # Generate attendance grid
        grid_df = generate_attendance_grid(year, month)
        
        if not grid_df.empty:
            # Apply custom CSS for the grid
            st.markdown('<div class="attendance-grid">', unsafe_allow_html=True)
            
            # Display the grid
            st.dataframe(
                grid_df,
                use_container_width=True,
                column_config={
                    "Name": st.column_config.TextColumn("Name", width="medium"),
                    "Shift": st.column_config.TextColumn("Shift", width="small"),
                    "Line": st.column_config.TextColumn("Line", width="small"),
                    "Present Days": st.column_config.NumberColumn("Present Days", format="%d"),
                    "Attendance %": st.column_config.NumberColumn("Attendance %", format="%.1f%%")
                }
            )
            
            st.markdown('</div>', unsafe_allow_html=True)
            
            # Export button
            excel_bytes = dataframe_to_excel_bytes(grid_df)
            st.download_button(
                "üì• Download Attendance Grid", 
                data=excel_bytes, 
                file_name=f"attendance_grid_{year}_{month}.xlsx", 
                mime="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"
            )
        else:
            st.info("No attendance data available for the selected period.")

# ==================== MAIN ====================
def main():
    # Apply mobile responsive CSS
    st.markdown(mobile_responsive_css(), unsafe_allow_html=True)
    
    st.set_page_config(page_title="Company Attendance", page_icon="üìã", layout="wide")
    
    initialize_system()

    if st.session_state.logged_in:
        with st.sidebar:
            st.write("### User")
            st.write(f"**{st.session_state.username}**")
            st.write(f"Role: {st.session_state.role}")
            st.markdown("---")
            
            # Check for offline data and show sync option
            offline_data = load_offline_data()
            if offline_data:
                st.warning("You have unsynced data")
                if st.button("Sync Offline Data", key="sidebar_sync"):
                    if sync_offline_data():
                        st.success("Data synced successfully!")
                        st.rerun()
                    else:
                        st.error("Sync failed. Please try again later.")
                st.markdown("---")
            
            if st.button("üö™ Logout", key="sidebar_logout"):
                st.session_state.logged_in = False
                st.session_state.username = None
                st.session_state.role = None
                st.session_state.user_id = None
                st.rerun()

        if st.session_state.role == "Admin":
            admin_dashboard()
        elif st.session_state.role == "Supervisor":
            supervisor_dashboard()
        elif st.session_state.role == "HR":
            hr_dashboard()
        else:
            st.error("Unknown role")
    else:
        login_page()

if __name__ == "__main__":
    main()